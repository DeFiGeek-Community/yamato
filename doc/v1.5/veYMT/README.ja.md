# veYMT Token

## 概要

veYMT Token は、YMT トークンをロックすることで得られる、ERC-20 互換のトークンです。ただし、このトークンは`transfer()`機能を持ちません。投票用のエスクロートークンとして機能し、ロックされたトークンには時間に応じた重みが付与されます。

#### 参考

- [Curve DAO: Vote-Escrowed CRV](https://etherscan.io/address/0x5f3b5dfeb7b28cdbd7faba78963ee202a494e2a2#readContract)
- [Curve VotingEscrow Contract](https://curve.readthedocs.io/dao-vecrv.html)
- [The Curve DAO: Liquidity Gauges and Minting CRV](https://curve.readthedocs.io/dao-gauges.html)
- [LiquidityGaugeV6 Contract](https://github.com/curvefi/tricrypto-ng/blob/main/contracts/main/LiquidityGauge.vy)

---

## イベント

### `Deposit`:

- **説明**: ユーザーがトークンをデポジットした際に発生します。
- **パラメータ**:
  - `provider`: デポジットしたユーザーのアドレス。
  - `value`: デポジットされたトークンの量。
  - `locktime`: ロックされる時間。
  - `ts`: タイムスタンプ。

### `Withdraw`:

- **説明**: ユーザーがトークンを引き出した際に発生します。
- **パラメータ**:
  - `provider`: 引き出したユーザーのアドレス。
  - `value`: 引き出されたトークンの量。
  - `ts`: タイムスタンプ。

### `Supply`:

- **説明**: 供給量が変更されたときにトリガーされるイベント。
- **パラメータ**:
  - `prevSupply`: 変更前の供給量。
  - `supply`: 新しい供給量。

---

## 変数

### `locked: public(mapping(address => LockedBalance))`

- **説明**: 各ユーザーのロックされたバランス（`LockedBalance`構造体）を保持するマッピングです。これには、ロックされたトークンの量（`amount`）と、ロックが終了する時間（`end`）が含まれます。

### `epoch: public(uint256)`

- **説明**: コントラクトの現在のエポック（期間）番号を示します。エポックは、システムの状態を追跡するための時間単位で、特定のイベントや変更が記録されるタイミングを表します。

### `token: public(address)`

- **説明**: veYMT トークンが基づく YMT トークンのアドレスを示します。これは、veYMT トークンが YMT トークンをロックするために使用される基本通貨のアドレスです。

### `supply: public(uint256)`

- **説明**: コントラクトにおける総供給量を示します。この値は、すべてのユーザーがロックしたトークンの総量を表し、veYMT の総発行量と見なすことができます。

### `pointHistory: public(mapping(uint256 => Point))`

- **説明**: 各エポックにおけるシステムの状態（`Point`構造体）を追跡するためのマッピングです。`Point`には、その時点のバイアス（`bias`）、傾斜（`slope`）、タイムスタンプ（`ts`）、ブロック番号（`blk`）が含まれます。

### `userPointHistory: public(mapping(address => mapping(uint256 => Point)))`

- **説明**: 各ユーザーごとに、異なるエポックでのユーザーの状態（`Point`構造体）を追跡するための二重マッピングです。これにより、ユーザーが過去にどのような投票力を持っていたかを把握することができます。

### `userPointEpoch: public(mapping(address => uint256))`

- **説明**: 各ユーザーの現在のエポック番号を保持するマッピングです。これは、ユーザーの最新の状態が記録されたエポックを示します。

### `slopeChanges: public(mapping(uint256 => int128))`

- **説明**: 未来の特定の時点で予定されている傾斜（`slope`）の変化を追跡するマッピングです。この値は、投票力の変化を表す際に使用されます。

### `controller: public(address)`

- **説明**: コントラクトのコントローラー（管理者）のアドレスです。コントローラーは、コントラクトの特定の機能を管理する責任を持ちます。

### `transfersEnabled: public(bool)`

- **説明**: トークンの転送が有効かどうかを示すブール値です。Aragon との互換性のために含まれていますが、veYMT トークンでは転送は基本的に行われません。

### `name: public(string)`

- **説明**: トークンの名前です。「Voting-escrowed Yamato」となります。

### `symbol: public(string)`

- **説明**: トークンのシンボルです。「veYMT」となります。

### `decimals: public(uint8)`

- **説明**: トークンの小数点以下の桁数です。YMT トークンの小数点以下の桁数に基づいて設定されます。

### `futureAdmin: public(address)`

- **説明**: 将来の管理者のアドレスです。これは、所有権の移転プロセス中に使用される一時的な変数です。所有権が正式に移転されると、`controller`が更新されます。

---

## 関数

### `constructor(tokenAddr_: address)`

- **説明**: veYMT コントラクトのコンストラクタです。YMT トークンのアドレスを受け取り、コントラクトの初期設定を行います。
- **パラメータ**:
  - `tokenAddr_`: YMT トークンのアドレス。

### `getLastUserSlope(addr_: address)`

- **説明**: 指定されたアドレスのユーザーの最新の投票力の減少率を取得します。
- **パラメータ**:
  - `addr_`: ユーザーのウォレットアドレス。

### `userPointHistoryTs(addr_: address, idx_: uint256)`

- **説明**: 指定されたアドレスのユーザーの特定のチェックポイントのタイムスタンプを取得します。
- **パラメータ**:
  - `addr_`: ユーザーのウォレットアドレス。
  - `idx_`: ユーザーのエポック番号。

### `lockedEnd(addr_: address)`

- **説明**: 指定されたアドレスのユーザーのロックが終了するタイムスタンプを取得します。
- **パラメータ**:
  - `addr_`: ユーザーのウォレットアドレス。

### `checkpoint()`

- **説明**: グローバルデータをチェックポイントとして記録します。この関数は外部から呼び出されることを意図しています。

### `depositFor(addr_: address, value_: uint256)`

- **説明**: 指定されたアドレスのユーザーのためにトークンをデポジットし、ロックします。この関数は外部から呼び出されることを意図しています。
- **パラメータ**:
  - `addr_`: トークンをデポジットするユーザーのアドレス。
  - `value_`: デポジットするトークンの量。

### `createLock(value_: uint256, unlockTime_: uint256)`

- **説明**: 新しいロックを作成し、トークンをデポジットします。ロックは指定された時間まで有効です。
- **パラメータ**:
  - `value_`: デポジットするトークンの量。
  - `unlockTime_`: トークンのロックを解除する時間（エポック秒）。

### `increaseAmount(value_: uint256)`

- **説明**: 既存のロックにトークンを追加します。ロックの期限は変更されません。
- **パラメータ**:
  - `value_`: 追加するトークンの量。

### `increaseUnlockTime(unlockTime_: uint256)`

- **説明**: ロックの解除時間を延長します。トークンの量は変更されません。
- **パラメータ**:
  - `unlockTime_`: 新しいロック解除時間（エポック秒）。

### `withdraw()`

- **説明**: ロックが解除されたトークンを引き出します。この関数は、ロックの期限が満了した後にのみ呼び出すことができます。

### `balanceOf(addr_: address, t_: uint256)`

- **説明**: 指定された時点での指定されたアドレスのユーザーの現在の投票力を取得します。
- **パラメータ**:
  - `addr_`: ユーザーのウォレットアドレス。
  - `t_`: 投票力を取得するエポック時間。

### `balanceOf(addr_: address)`

- **説明**: 現在時点での指定されたアドレスのユーザーの投票力を取得します。
- **パラメータ**:
  - `addr_`: ユーザーのウォレットアドレス。

### `balanceOfAt(addr_: address, block_: uint256)`

- **説明**: 特定のブロック高さでの指定されたアドレスのユーザーの投票力を測定します。
- **パラメータ**:
  - `addr_`: ユーザーのウォレットアドレス。
  - `block_`: 投票力を計算するブロック番号。

### `totalSupply(t_: uint256)`

- **説明**: 指定された時点での総投票力を計算します。
- **パラメータ**:
  - `t_`: 総投票力を計算するエポック時間。

### `totalSupply()`

- **説明**: 現在時点での総投票力を計算します。

### `totalSupplyAt(block_: uint256)`

- **説明**: 過去の特定のブロックでの総投票力を計算します。
- **パラメータ**:
  - `block_`: 総投票力を計算するブロック番号。

### `changeController(newController: address)`

- **説明**: コントローラーを変更します。この機能は、現在のコントローラーのみが呼び出すことができます。
- **パラメータ**:
  - `newController`: 新しいコントローラーのアドレス。

---

## コントラクトの詳細

### veYMT コントラクト:

- **目的**: veYMT コントラクトは、YMT トークンをロックして、ロック期間に応じた投票権を提供する機能を実装しています。ロックされたトークンは、所定の期間が経過するまで引き出すことができません。

### ロックメカニズム:

- **ロックの仕組み**: ユーザーは YMT トークンを veYMT コントラクトに預けることで、ロックされたトークンに基づく投票権を獲得します。ロック期間はユーザーによって設定され、最大で 4 年間です。
  veYMT トークンにおける投票権の変化は、ロックされたトークンの量とロック期間に基づいて計算されます。この計算には「バイアス」と「スロープ」という二つの概念が関係します。

### バイアスとスロープ

- **バイアス (Bias)**: ある時点でのユーザーの投票権の量を示します。これは、ロックされたトークンの量とロック期間に比例します。
- **スロープ (Slope)**: バイアスが時間とともにどのように減少するかを示す値です。これは、ロックされたトークンの量に依存し、ロック期間が経過するにつれて減少します。

## 投票権の計算

投票権の計算においては、次の数式が用いられます:

$$ \text{バイアス} = \text{スロープ} \times (\text{ロック終了時刻} - \text{現在時刻}) $$

ここで、

- **ロック終了時刻**: ユーザーが設定したトークンのロックが解除される時刻。
- **現在時刻**: 現在の時刻。

### 例

例えば、ユーザーが 100 veYMT トークンを 4 年間ロックするとします。この場合、スロープはロック量を最大ロック期間で割った値になります。

$$ \text{スロープ} = \frac{100 \text{ veYMT}}{4 \times 365 \times 24 \times 3600 \text{ 秒}} $$

ロックが開始された時点でのバイアスは、スロープにロック期間を掛けたものに等しくなります。したがって、バイアスは初め 100 veYMT となりますが、時間が経過するにつれて徐々に減少していきます。

### ロック期間の影響

- **長期ロックの利点**: 長期にわたってトークンをロックするほど、初期のバイアスは大きくなり、投票権の量も多くなります。
- **時間経過とともの減少**: しかし、時間が経過するにつれて、スロープによりバイアスは減少し、投票権も徐々に減少していきます。

このように veYMT トークンでは、ロック期間が長いほど、初期の投票権は多くなりますが、その権利は時間とともに減少していきます。このメカニズムにより、ユーザーは長期的なコミットメントを通じてより大きな投票権を得ることができますが、ロック期間が経過するにつれてその影響力は減少していきます。

### ユーザーインタラクション:

- **デポジット**: ユーザーは特定の量の YMT トークンをデポジットし、特定の期間でロックすることができます。
- **ロックの増加**: ユーザーは既存のロックにトークンを追加するか、ロック期間を延長することが可能です。
- **引き出し**: ロック期間が終了した後、ユーザーはロックされたトークンを引き出すことができます。
